name: Build and Deploy to S3 with CodeDeploy

on:
  push:
    branches: [ "main", "back-develop" ]
    paths:
      - 'daycan-back/**'

permissions:
  contents: read

env:
  AWS_REGION: ap-northeast-2
  S3_BUCKET: ${{ secrets.S3_BUCKET }}                    # S3 ë²„í‚·ëª…
  CODEDEPLOY_APP: ${{ secrets.CODEDEPLOY_APP }}          # ê¸°ì¡´ì— ìƒì„±ëœ CodeDeploy ì• í”Œë¦¬ì¼€ì´ì…˜ëª…
  CODEDEPLOY_GROUP: ${{ secrets.CODEDEPLOY_GROUP }}      # ê¸°ì¡´ì— ìƒì„±ëœ CodeDeploy ë°°í¬ ê·¸ë£¹ëª…

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    # daycan-back ë””ë ‰í† ë¦¬ì—ì„œ ìž‘ì—… (ë£¨íŠ¸ Gradle í”„ë¡œì íŠ¸)
    # TODO: daycan-back ë””ë ‰í† ë¦¬ì—ì„œ ë©€í‹°ëª¨ë“ˆë¡œ ìž‘ì—…í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì „í™˜
    defaults:
      run:
        working-directory: daycan-back/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Amazon Corretto 17
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: |
          if [ -f gradlew ]; then
            chmod +x gradlew
            echo "âœ… Made gradlew executable"
          else
            echo "âŒ gradlew not found in current directory"
            exit 1
          fi

      # TODO:í…ŒìŠ¤íŠ¸ ë‹¨ê³„ ì¶”ê°€
      - name: Build with Gradle
        run: |
          echo "ðŸ”¨ Building Spring Boot application (api module)..."
          ./gradlew clean bootJar
          echo "âœ… Build completed successfully!"

      - name: Make daycan.env file
        run: |
          echo "ðŸ”¨ Making daycan.env file..."
          echo "DB_URL=${{ secrets.DB_URL }}" >> daycan.env
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> daycan.env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> daycan.env
          echo "SPRING_PROFILES_ACTIVE=develop" >> daycan.env
          echo "DAYCAN_PORT=8080" >> daycan.env
          echo "âœ… daycan.env file created successfully!"

      - name: Prepare CodeDeploy bundle
        run: |
          echo "ðŸ“‹ Preparing CodeDeploy deployment bundle..."
          # íƒ€ìž„ìŠ¤íƒ¬í”„ì™€ ì»¤ë°‹ í•´ì‹œë¡œ ê³ ìœ í•œ ë°°í¬ ID ìƒì„±
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          COMMIT_HASH=${GITHUB_SHA::7}
          JAR_FILE=$(ls -t build/libs/*.jar | grep -v 'plain.jar' | head -n 1)
          
          # ë°°í¬ ë²ˆë“¤ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p deployment-bundle/app
          mkdir -p deployment-bundle/scripts
          
          # JAR íŒŒì¼ì„ app.jarë¡œ ë³µì‚¬
          cp "$JAR_FILE" deployment-bundle/app/app.jar
          echo "âœ… Copied JAR file to deployment bundle"
          
          # appspec.ymlê³¼ scripts ë³µì‚¬ (ìƒìœ„ ë””ë ‰í† ë¦¬ì—ì„œ)
          cp ../appspec.yml deployment-bundle/
          cp ../daycan.env deployment-bundle/
          cp -r ../scripts/* deployment-bundle/scripts/
          echo "âœ… Copied appspec.yml and scripts"
          
          # ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x deployment-bundle/scripts/*.sh
          
          # ë°°í¬ ë²ˆë“¤ ì••ì¶•
          BUNDLE_NAME="daycan-back-${TIMESTAMP}-${COMMIT_HASH}.zip"
          cd deployment-bundle
          zip -r "../$BUNDLE_NAME" .
          cd ..
          
          echo "UPLOAD_FILE=$BUNDLE_NAME" >> $GITHUB_ENV
          echo "S3_KEY=deploy/daycan-back/$BUNDLE_NAME" >> $GITHUB_ENV
          echo "DEPLOYMENT_ID=${TIMESTAMP}-${COMMIT_HASH}" >> $GITHUB_ENV
          echo "âœ… CodeDeploy bundle prepared: $BUNDLE_NAME"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload deployment bundle to S3
        run: |
          echo "ðŸ“¤ Uploading deployment bundle to S3..."
          aws s3 cp "$UPLOAD_FILE" "s3://${S3_BUCKET}/${S3_KEY}"
          echo "âœ… Successfully uploaded to: s3://${S3_BUCKET}/${S3_KEY}"

      - name: Create CodeDeploy deployment
        id: deploy
        run: |
          echo "ðŸš€ Creating CodeDeploy deployment..."
          DEPLOYMENT_ID_RESULT=$(aws deploy create-deployment \
            --application-name "${CODEDEPLOY_APP}" \
            --deployment-group-name "${CODEDEPLOY_GROUP}" \
            --revision "revisionType=S3,s3Location={bucket=${S3_BUCKET},key=${S3_KEY},bundleType=zip}" \
            --description "Deploy ${GITHUB_SHA} from ${GITHUB_REF_NAME} (${DEPLOYMENT_ID})" \
            --query "deploymentId" --output text)
          
          echo "CODEDEPLOY_ID=$DEPLOYMENT_ID_RESULT" | tee -a $GITHUB_ENV
          echo "deployment_id=$DEPLOYMENT_ID_RESULT" >> $GITHUB_OUTPUT
          echo "âœ… CodeDeploy deployment created: $DEPLOYMENT_ID_RESULT"

      - name: Deployment summary
        run: |
          echo "ðŸŽ¯ Deployment Summary:"
          echo "- Application: ${CODEDEPLOY_APP}"
          echo "- Deployment Group: ${CODEDEPLOY_GROUP}"
          echo "- Deployment ID: ${CODEDEPLOY_ID:-N/A}"
          echo "- S3 Bundle: s3://${S3_BUCKET}/${S3_KEY}"
          echo "- Build Time: $(date)"
          echo "- Commit: ${GITHUB_SHA}"
          echo "- Branch: ${GITHUB_REF_NAME}"